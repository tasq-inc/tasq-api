FROM tasq-celery-base:latest as builder

RUN apk update \
    && apk add --upgrade --no-cache \
        bash openssh curl ca-certificates openssl less htop \
		g++ make wget rsync \
        build-base libpng-dev freetype-dev libexecinfo-dev openblas-dev libgomp lapack-dev \
		libgcc libquadmath musl  \
		libgfortran \
		lapack-dev \
	&&  pip install --no-cache-dir --upgrade pip \
	&&  pip install scipy==1.3.1

RUN pip install --no-cache-dir \
    "traces==0.5.2" \
    "requests" \
    "requests-aws4auth"




# Checking out this
RUN pip install --no-cache-dir cython
RUN pip install --no-cache-dir scikit-learn

FROM tasq-celery-base:latest as final

ARG DEPLOY_STAGE
ENV ENV_DEPLOY_STAGE=$DEPLOY_STAGE

RUN apk add libgomp

RUN pip install --no-cache-dir joblib


# 10.0.1.144 For dev
# 10.255.1.224 for prod
RUN pip3 install -i http://tasq:tasq@10.0.1.144:9999/simple/ --trusted-host 10.0.1.144 tasq-logging-helper

RUN pip install --no-cache-dir \
    "traces==0.5.2" \
    "requests" \
    "requests-aws4auth"


RUN mkdir /usr/local/lib/python3.7/site-packages/scipy
RUN mkdir /usr/local/lib/python3.7/site-packages/sklearn


COPY --from=builder /usr/local/lib/python3.7/site-packages/scipy /usr/local/lib/python3.7/site-packages/scipy
COPY --from=builder /usr/local/lib/python3.7/site-packages/sklearn /usr/local/lib/python3.7/site-packages/sklearn
COPY --from=builder /usr/lib/libcblas* /usr/local/lib/
COPY --from=builder /usr/lib/libblas* /usr/local/lib/
COPY --from=builder /usr/lib/libopenblas* /usr/local/lib/
COPY --from=builder /usr/lib/libgfortran* /usr/local/lib/
COPY --from=builder /usr/lib/liblapack* /usr/local/lib/
COPY --from=builder /usr/lib/libquadmath* /usr/local/lib/


COPY main /opt/program/main
WORKDIR /opt/program/main
